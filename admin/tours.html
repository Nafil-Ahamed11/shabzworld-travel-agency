<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dubai Tours - Tour Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" />
  <!-- Custom CSS -->
  <link rel="stylesheet" href="../assets/css/admin.css" />
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-dark sidebar collapse">
        <div class="position-sticky pt-3">
          <div class="text-center mb-4">
            <h4 class="text-white">Dubai Tours</h4>
            <p class="text-white-50">Admin Dashboard</p>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="dashboard.html">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="tours.html">
                <i class="fas fa-route me-2"></i>Tours
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="bookings.html">
                <i class="fas fa-calendar-check me-2"></i>Bookings
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="users.html">
                <i class="fas fa-users me-2"></i>Users
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" id="logout-btn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
        <div
          class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
        >
          <h1 class="h2">Tour Management</h1>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTourModal">
            <i class="fas fa-plus me-1"></i> Add New Tour
          </button>
        </div>

        <!-- Tours Table -->
        <div class="card shadow mb-4">
          <div class="card-body">
            <div class="table-responsive">
              <table
                class="table table-bordered"
                id="toursTable"
                width="100%"
                cellspacing="0"
              >
                <thead>
                  <tr>
                    <th>Image</th>
                    <th>Title</th>
                    <th>Location</th>
                    <th>Category</th>
                    <th>Rating</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="tours-list">
                  <!-- Tours will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Tour Modal -->
  <div
    class="modal fade"
    id="addTourModal"
    tabindex="-1"
    aria-labelledby="addTourModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="addTourForm">
          <div class="modal-header">
            <h5 class="modal-title" id="addTourModalLabel">Add New Tour</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="tourTitle" class="form-label">Title</label>
                <input type="text" class="form-control" id="tourTitle" required />
              </div>
              <div class="col-md-6">
                <label for="tourLocation" class="form-label">Location</label>
                <input type="text" class="form-control" id="tourLocation" required />
              </div>
              <div class="col-md-6">
                <label for="tourCategory" class="form-label">Category</label>
                <input type="text" class="form-control" id="tourCategory" required />
              </div>
              <div class="col-md-6">
                <label for="tourRating" class="form-label">Rating</label>
                <input
                  type="number"
                  step="0.1"
                  min="0"
                  max="5"
                  class="form-control"
                  id="tourRating"
                  required
                />
              </div>
              <div class="col-md-6">
                <label for="tourImage" class="form-label">Image URL</label>
                <input type="url" class="form-control" id="tourImage" required />
              </div>
              <div class="col-md-6">
                <label for="tourAlt" class="form-label">Image Alt Text</label>
                <input type="text" class="form-control" id="tourAlt" required />
              </div>
              <div class="col-md-6">
                <label for="tourLink" class="form-label">Tour Link</label>
                <input type="url" class="form-control" id="tourLink" required />
              </div>
              <div class="col-md-6">
                <label for="tourBookingLink" class="form-label">Booking Link</label>
                <input type="url" class="form-control" id="tourBookingLink" required />
              </div>
              <div class="col-md-6">
                <label for="tourCategoryValue" class="form-label">Category Value</label>
                <input type="text" class="form-control" id="tourCategoryValue" required />
              </div>
              <div class="col-md-6">
                <label for="tourSectionValue" class="form-label">Section Value</label>
                <input type="text" class="form-control" id="tourSectionValue" required />
              </div>
              <div class="col-md-6">
                <label for="tourSectionDisplay" class="form-label">Section Display</label>
                <input type="text" class="form-control" id="tourSectionDisplay" required />
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button type="submit" class="btn btn-primary">Add Tour</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <script>
    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Function to render tours in the table
    function renderTours(tours) {
      const toursList = document.getElementById("tours-list");
      toursList.innerHTML = "";
      tours.forEach((tour) => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td><img src="${tour.image}" alt="${tour.alt}" style="width: 100px; height: 60px; object-fit: cover; border-radius: 4px;" /></td>
          <td>${tour.title}</td>
          <td>${tour.location}</td>
          <td>${tour.category.display}</td>
          <td>${tour.rating}</td>
          <td>
            <button class="btn btn-sm btn-warning me-2 edit-btn" data-id="${tour.id}"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-danger delete-btn" data-id="${tour.id}"><i class="fas fa-trash"></i></button>
          </td>
        `;

        toursList.appendChild(tr);
      });

      // Add event listeners for edit and delete buttons
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-id");
          editTour(id);
        });
      });

      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const id = e.currentTarget.getAttribute("data-id");
          deleteTour(id);
        });
      });
    }

    // Load tours from Firestore
    function loadTours() {
      db.collection("tours")
        .get()
        .then((querySnapshot) => {
          const tours = [];
          querySnapshot.forEach((doc) => {
            tours.push({ id: doc.id, ...doc.data() });
          });
          renderTours(tours);
        })
        .catch((error) => {
          console.error("Error loading tours: ", error);
        });
    }

    // Add new tour
    document.getElementById("addTourForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const newTour = {
        title: document.getElementById("tourTitle").value,
        location: document.getElementById("tourLocation").value,
        category: {
          value: document.getElementById("tourCategoryValue").value,
          display: document.getElementById("tourCategory").value,
        },
        rating: parseFloat(document.getElementById("tourRating").value),
        image: document.getElementById("tourImage").value,
        alt: document.getElementById("tourAlt").value,
        link: document.getElementById("tourLink").value,
        bookingLink: document.getElementById("tourBookingLink").value,
        section: {
          value: document.getElementById("tourSectionValue").value,
          display: document.getElementById("tourSectionDisplay").value,
        },
      };

      db.collection("tours")
        .add(newTour)
        .then(() => {
          // Close modal
          const addTourModal = bootstrap.Modal.getInstance(document.getElementById("addTourModal"));
          addTourModal.hide();

          // Reset form
          document.getElementById("addTourForm").reset();

          // Reload tours
          loadTours();
        })
        .catch((error) => {
          console.error("Error adding tour: ", error);
        });
    });

    // Delete tour
    function deleteTour(id) {
      if (confirm("Are you sure you want to delete this tour?")) {
        db.collection("tours")
          .doc(id)
          .delete()
          .then(() => {
            loadTours();
          })
          .catch((error) => {
            console.error("Error deleting tour: ", error);
          });
      }
    }

    // Edit tour (simple implementation: load data into modal for now)
    function editTour(id) {
      db.collection("tours")
        .doc(id)
        .get()
        .then((doc) => {
          if (doc.exists) {
            const tour = doc.data();
            document.getElementById("tourTitle").value = tour.title;
            document.getElementById("tourLocation").value = tour.location;
            document.getElementById("tourCategory").value = tour.category.display;
            document.getElementById("tourCategoryValue").value = tour.category.value;
            document.getElementById("tourRating").value = tour.rating;
            document.getElementById("tourImage").value = tour.image;
            document.getElementById("tourAlt").value = tour.alt;
            document.getElementById("tourLink").value = tour.link;
            document.getElementById("tourBookingLink").value = tour.bookingLink;
            document.getElementById("tourSectionValue").value = tour.section.value;
            document.getElementById("tourSectionDisplay").value = tour.section.display;

            // Change modal title and button
            document.getElementById("addTourModalLabel").textContent = "Edit Tour";
            document.querySelector("#addTourForm button[type='submit']").textContent = "Save Changes";

            // Show modal
            const addTourModal = new bootstrap.Modal(document.getElementById("addTourModal"));
            addTourModal.show();

            // Change form submit handler to update
            const form = document.getElementById("addTourForm");
            form.removeEventListener("submit", addTourSubmitHandler);
            form.addEventListener("submit", function updateHandler(event) {
              event.preventDefault();
              const updatedTour = {
                title: document.getElementById("tourTitle").value,
                location: document.getElementById("tourLocation").value,
                category: {
                  value: document.getElementById("tourCategoryValue").value,
                  display: document.getElementById("tourCategory").value,
                },
                rating: parseFloat(document.getElementById("tourRating").value),
                image: document.getElementById("tourImage").value,
                alt: document.getElementById("tourAlt").value,
                link: document.getElementById("tourLink").value,
                bookingLink: document.getElementById("tourBookingLink").value,
                section: {
                  value: document.getElementById("tourSectionValue").value,
                  display: document.getElementById("tourSectionDisplay").value,
                },
              };
              db.collection("tours")
                .doc(id)
                .update(updatedTour)
                .then(() => {
                  // Close modal
                  const addTourModal = bootstrap.Modal.getInstance(document.getElementById("addTourModal"));
                  addTourModal.hide();

                  // Reset form
                  form.reset();

                  // Reset modal title and button
                  document.getElementById("addTourModalLabel").textContent = "Add New Tour";
                  document.querySelector("#addTourForm button[type='submit']").textContent = "Add Tour";

                  // Remove this update handler and restore add handler
                  form.removeEventListener("submit", updateHandler);
                  form.addEventListener("submit", addTourSubmitHandler);

                  // Reload tours
                  loadTours();
                })
                .catch((error) => {
                  console.error("Error updating tour: ", error);
                });
            });
          } else {
            alert("Tour not found!");
          }
        })
        .catch((error) => {
          console.error("Error fetching tour: ", error);
        });
    }

    // Store the original add submit handler to re-attach after edit
    function addTourSubmitHandler(e) {
      e.preventDefault();

      const newTour = {
        title: document.getElementById("tourTitle").value,
        location: document.getElementById("tourLocation").value,
        category: {
          value: document.getElementById("tourCategoryValue").value,
          display: document.getElementById("tourCategory").value,
        },
        rating: parseFloat(document.getElementById("tourRating").value),
        image: document.getElementById("tourImage").value,
        alt: document.getElementById("tourAlt").value,
        link: document.getElementById("tourLink").value,
        bookingLink: document.getElementById("tourBookingLink").value,
        section: {
          value: document.getElementById("tourSectionValue").value,
          display: document.getElementById("tourSectionDisplay").value,
        },
      };

      db.collection("tours")
        .add(newTour)
        .then(() => {
          // Close modal
          const addTourModal = bootstrap.Modal.getInstance(document.getElementById("addTourModal"));
          addTourModal.hide();

          // Reset form
          document.getElementById("addTourForm").reset();

          // Reload tours
          loadTours();
        })
        .catch((error) => {
          console.error("Error adding tour: ", error);
        });
    }

    // Attach the original add submit handler
    document.getElementById("addTourForm").addEventListener("submit", addTourSubmitHandler);

    // Load tours on page load
    window.addEventListener("DOMContentLoaded", () => {
      loadTours();
    });
  </script>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
